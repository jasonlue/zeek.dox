<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.3"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>zeek: README</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">zeek<span id="projectnumber">&#160;5.1.0</span>
   </div>
   <div id="projectbrief">github.com/zeek/zeek</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "../../search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div><div class="header">
  <div class="headertitle"><div class="title">README </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1 align="center">Compiling Zeek Scripts To C++: User's Guide </h1>
<h4 align="center">@ref overview "_Overview_" - @ref workflows "_Workflows_" - @ref known-issues "_Known Issues_" - </h4>
<p ><br  />
</p>
<h2><a class="anchor" id="autotoc_md0"></a>
Overview</h2>
<p >Zeek's <em>script compiler</em> is an experimental feature that translates Zeek scripts into C++, which is then compiled directly into the <code>zeek</code> binary in order to gain higher performance by removing the need for Zeek to use an interpreter to execute the scripts. Using this feature requires a somewhat complex workflow.</p>
<p >How much faster will your scripts run? There's no simple answer to that. It depends heavily on several factors:</p>
<ul>
<li>What proportion of the processing during execution is spent in Zeek's <em>Event Engine</em> rather than executing scripts.</li>
<li>What proportion of the script's processing is spent executing built-in functions (BiFs). It might well be that most of your script processing actually occurs inside the <em>Logging Framework</em>, for example, and thus you won't see much improvement.</li>
<li>Those two factors add up to gains often on the order of only 10-15%, rather than something a lot more dramatic. On the other hand, using this feature you can afford to put significantly more functionality in Zeek scripts without worrying as much about introducing performance bottlenecks.</li>
</ul>
<p >That said, I'm very interested in situations where the performance gains appear unsatisfying. Also note that when using the compiler, you can analyze the performance of your scripts using C++-oriented tools - the translated C++ code generally bears a clear relationship with the original Zeek script.</p>
<p >If you want to know how the compiler itself works, see the sketch at the beginning of <code>Compile.h</code>.</p>
<p ><br  />
</p>
<h2><a class="anchor" id="autotoc_md1"></a>
Workflows</h2>
<p ><em>Before building Zeek</em>, see the first of the _Known Issues_ below regarding compilation times. If your aim is to exploration of the functionality rather than production use, you might want to build Zeek using <code>./configure --enable-debug</code>, which can reduce compilation times by 50x (!). Once you've built it, the following sketches how to create and use compiled scripts.</p>
<p >The main code generated by the compiler is taken from <code>build/CPP-gen.cc</code>. An empty version of this is generated when first building Zeek.</p>
<p >As a user, the most common workflow is to build a version of Zeek that has a given target script (<code>target.zeek</code>) compiled into it. This means <em>all of the code pulled in by <code>target.zeek</code></em>, including the base scripts (or the "bare" subset if you invoke the compiler when running <code>zeek -b</code>). The following workflow assumes you are in the <code>build/</code> subdirectory:</p>
<ol type="1">
<li><code>./src/zeek -O gen-C++ target.zeek</code> <br  />
 The generated code is written to <code>CPP-gen.cc</code>.</li>
<li><code>ninja</code> or <code>make</code> to recompile Zeek</li>
<li><code>./src/zeek -O use-C++ target.zeek</code> <br  />
 Executes with each function/hook/event handler pulled in by <code>target.zeek</code> replaced with its compiled version.</li>
</ol>
<p >Instead of the last line above, you can use the following variants:</p>
<ol type="1">
<li><code>./src/zeek -O report-C++ target.zeek</code> <br  />
 For each function body in <code>target.zeek</code>, reports which ones have compiled-to-C++ bodies available, and also any compiled-to-C++ bodies present in the <code>zeek</code> binary that <code>target.zeek</code> does not use. Useful for debugging.</li>
</ol>
<p >The above workflows require the subsequent <code>zeek</code> execution to include the <code>target.zeek</code> script. You can avoid this by replacing the first step with:</p>
<ol type="1">
<li><code>./src/zeek -O gen-standalone-C++ target.zeek &gt;target-stand-in.zeek</code></li>
</ol>
<p >(and then building as in the 2nd step above). This option prints to <em>stdout</em> a (very short) "stand-in" Zeek script that you can load using <code>target-stand-in.zeek</code> to activate the compiled <code>target.zeek</code> without needing to include <code>target.zeek</code> in the invocation (nor the <code>-O use-C++</code> option). After loading the stand-in script, you can still access types and functions declared in <code>target.zeek</code>.</p>
<p >Note: the implementation differences between <code>gen-C++</code> and <code>gen-standalone-C++</code> wound up being modest enough that it might make sense to just always provide the latter functionality, which it turns out does not introduce any additional constraints compared to the current <code>gen-C++</code> functionality. On the other hand, it's possible (not yet established) that code created using <code>gen-C++</code> can be made to compile significantly faster than standalone code.</p>
<p >Another option, <code>-O add-C++</code>, instead <em>appends</em> the generated code to existing C++ in <code>CPP-gen.cc</code>. You can use this option repeatedly for different scripts and then compile the collection <em>en masse</em>.</p>
<p >There are additional workflows relating to running the test suite, which we document only briefly here as they're likely going to change or go away , as it's not clear they're actually needed.</p>
<ul>
<li><code>non-embedded-build</code> <br  />
 Builds <code>zeek</code> without any embedded compiled-to-C++ scripts.</li>
<li><code>bare-embedded-build</code> <br  />
 Builds <code>zeek</code> with the <code>-b</code> "bare-mode" scripts compiled in.</li>
<li><code>full-embedded-build</code> <br  />
 Builds <code>zeek</code> with the default scripts compiled in.</li>
</ul>
<p ><br  />
</p>
<ul>
<li><code>eval-test-suite</code> <br  />
 Runs the test suite using the <code>cpp</code> alternative over the given set of tests.</li>
<li><code>test-suite-build</code> <br  />
 Incrementally compiles to <code>CPP-gen-addl.h</code> code for the given test suite elements.</li>
</ul>
<p ><br  />
</p>
<ul>
<li><code>single-test.sh</code> <br  />
 Builds the given btest test as a single <code>add-C++</code> add-on and then runs it.</li>
<li><code>single-full-test.sh</code> <br  />
 Builds the given btest test from scratch as a self-contained <code>zeek</code>, and runs it.</li>
<li><code>update-single-test.sh</code> <br  />
 Given an already-compiled <code>zeek</code> for the given test, updates its <code>cpp</code> test suite alternative.</li>
</ul>
<p >Some of these scripts could be made less messy if <code>btest</code> supported a "dry run" option that reported the executions it would do for a given test without actually undertaking them.</p>
<p ><br  />
</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Known Issues</h2>
<p >Here we list various known issues with using the compiler: <br  />
</p>
<ul>
<li>Compilation of compiled code can be quite slow when the C++ compilation includes optimization, taking many minutes on a beefy laptop. This slowness complicates CI/CD approaches for always running compiled code against the test suite when merging changes.</li>
<li>Run-time error messages generally lack location information and information about associated expressions/statements, making them hard to puzzle out. This could be fixed, but would add execution overhead in passing around the necessary strings / <code>Location</code> objects.</li>
<li>To avoid subtle bugs, the compiler will refrain from compiling script elements (functions, hooks, event handlers) that include conditional code. In addition, when using <code>--optimize-files</code> it will not compile any functions appearing in a source file that includes conditional code (even if it's not in a function body).</li>
<li>Code compiled with <code>-O gen-standalone-C++</code> will not execute any global statements when invoked using the "stand-in" script. The right fix for this is to shift from encapsulating global statements in a pseudo-function, as currently done, to instead be in a pseudo-event handler.</li>
<li>Code compiled with <code>-O gen-standalone-C++</code> likely has bugs if that code requires initializing a global variable that specifies extend fields in an extensible record (i.e., fields added using <code>redef</code>).</li>
<li>If a lambda generates an event that is not otherwise referred to, that event will not be registered upon instantiating the lambda. This is not particularly difficult to fix.</li>
<li>A number of steps could be taken to increase the performance of the optimized code. These include:<ol type="1">
<li>Switching the generated code to use the new ZVal-related interfaces, including for vector operations.</li>
<li>Directly calling BiFs rather than using the <code>Invoke()</code> method to do so. This relates to the broader question of switching BiFs to be based on a notion of "inlined C++" code in Zeek functions, rather than using the standalone <code>bifcl</code> BiF compiler.</li>
<li>Switching the Event Engine over to queuing events with <code>ZVal</code> arguments rather than <code>ValPtr</code> arguments.</li>
<li>Making the compiler aware of certain BiFs that can be directly inlined (e.g., <code><a class="el" href="../../da/dee/namespacezeek_1_1run__state.html#a30d9d14d2de95e2f18d725065711ec55">network_time()</a></code>), a technique employed effectively by the ZAM compiler.</li>
<li>Inspecting the generated code for inefficiencies that the compiler could avoid. </li>
</ol>
</li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.3
</small></address>
</body>
</html>
